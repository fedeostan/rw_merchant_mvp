openapi: 3.0.3
info:
  title: Merchant Crypto Wallet Dashboard API
  version: 0.1.0
  description: |
    MVP API contract for merchant crypto wallet dashboard

    ## Authentication
    This API uses Supabase Auth for authentication. Users authenticate via OTP (One-Time Password)
    sent to their email. The authentication flow is handled directly by Supabase Auth client,
    not through these API endpoints.

    For protected endpoints, include the Supabase session access token in the Authorization header:
    `Authorization: Bearer <supabase_access_token>`

servers:
  - url: /api
    description: API base URL

paths:
  /auth/otp/send:
    post:
      summary: Send OTP to email (DEPRECATED)
      deprecated: true
      description: |
        **DEPRECATED:** This endpoint is no longer used. Authentication is now handled
        directly by Supabase Auth client using `supabase.auth.signInWithOtp()`.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
      responses:
        '204':
          description: OTP sent successfully

  /auth/otp/verify:
    post:
      summary: Verify OTP and authenticate (DEPRECATED)
      deprecated: true
      description: |
        **DEPRECATED:** This endpoint is no longer used. OTP verification is now handled
        directly by Supabase Auth client using `supabase.auth.verifyOtp()`.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - code
              properties:
                email:
                  type: string
                  format: email
                code:
                  type: string
      responses:
        '200':
          description: Authentication successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'

  /me:
    get:
      summary: Get current user and org
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User and org info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MeResponse'

  /orgs/{orgId}/balance:
    get:
      summary: Get balance for organization
      description: |
        Calculate organization balance from all transactions.
        Available balance = SUM(amount WHERE type='in' AND status='posted') - SUM(amount WHERE type='out' AND status='posted')
        Pending balance = SUM(amount WHERE type='in' AND status='pending') - SUM(amount WHERE type='out' AND status='pending')
      security:
        - bearerAuth: []
      parameters:
        - name: orgId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Balance information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MoneyBalance'

  /orgs/{orgId}/transactions:
    get:
      summary: List transactions with pagination
      security:
        - bearerAuth: []
      parameters:
        - name: orgId
          in: path
          required: true
          schema:
            type: string
        - name: moduleId
          in: query
          schema:
            type: string
        - name: type
          in: query
          schema:
            $ref: '#/components/schemas/TransactionType'
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/TransactionStatus'
        - name: cursor
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Paginated transactions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionsResponse'

  /orgs/{orgId}/modules:
    get:
      summary: List modules for org
      security:
        - bearerAuth: []
      parameters:
        - name: orgId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: List of modules
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Module'
    post:
      summary: Create a new module
      security:
        - bearerAuth: []
      parameters:
        - name: orgId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateModuleRequest'
      responses:
        '200':
          description: Created module
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Module'

  /orgs/{orgId}/modules/{moduleId}:
    get:
      summary: Get a single module
      security:
        - bearerAuth: []
      parameters:
        - name: orgId
          in: path
          required: true
          schema:
            type: string
        - name: moduleId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Module details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Module'
        '404':
          description: Module not found
    patch:
      summary: Update a module
      security:
        - bearerAuth: []
      parameters:
        - name: orgId
          in: path
          required: true
          schema:
            type: string
        - name: moduleId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateModuleRequest'
      responses:
        '200':
          description: Updated module
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Module'
        '404':
          description: Module not found
    delete:
      summary: Delete a module
      security:
        - bearerAuth: []
      parameters:
        - name: orgId
          in: path
          required: true
          schema:
            type: string
        - name: moduleId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Module deleted successfully
        '404':
          description: Module not found

  /orgs/{orgId}/apikeys:
    get:
      summary: List API keys for org
      security:
        - bearerAuth: []
      parameters:
        - name: orgId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: List of API keys
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiKeysResponse'
    post:
      summary: Create a new API key
      security:
        - bearerAuth: []
      parameters:
        - name: orgId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  description: Optional label for the API key (e.g., "Production API")
      responses:
        '200':
          description: Created API key (full key is only shown once)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiKeyResponse'

  /wallet/buy:
    post:
      summary: Buy MNEE and create transaction
      description: |
        Create an incoming transaction for buying MNEE with a payment method.
        This will:
        - Create a transaction with type='in', method='card', display_type='buy', status='posted'
        - Assign to default "Wallet" module (creates if doesn't exist)
        - Generate realistic mock blockchain hash (tx_hash_in)
        - Return real transaction ID and full transaction details
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - amount
                - paymentMethod
              properties:
                amount:
                  type: number
                  format: double
                  description: Amount of MNEE to buy
                paymentMethod:
                  type: string
                  description: Payment method used (e.g., "Visa ending in 1234")
      responses:
        '201':
          description: Transaction created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  transactionId:
                    type: string
                  transaction:
                    $ref: '#/components/schemas/Transaction'
        '400':
          description: Invalid request data
        '401':
          description: Unauthorized

  /wallet/sell:
    post:
      summary: Sell MNEE and create transaction
      description: |
        Create an outgoing transaction for selling MNEE to bank account.
        This will:
        - **Validate sufficient balance** before allowing the transaction
        - Create a transaction with type='out', method='bank', display_type='sell', status='posted'
        - Assign to default "Wallet" module
        - Return real transaction ID and full transaction details
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - amount
              properties:
                amount:
                  type: number
                  format: double
                  description: Amount of MNEE to sell
      responses:
        '201':
          description: Transaction created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  transactionId:
                    type: string
                  transaction:
                    $ref: '#/components/schemas/Transaction'
        '400':
          description: Invalid request data or insufficient balance
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  details:
                    type: object
                    properties:
                      requested:
                        type: number
                      available:
                        type: number
        '401':
          description: Unauthorized

  /wallet/send:
    post:
      summary: Send MNEE to another wallet
      description: |
        Create an outgoing transaction for sending MNEE to another wallet address.
        This will:
        - **Validate sufficient balance** before allowing the transaction
        - Create a transaction with type='out', method='transfer', display_type='send', status='posted'
        - Store recipient address in customer_address field
        - Generate mock blockchain transaction hash (send_hash)
        - Assign to default "Wallet" module
        - Return real transaction ID, transaction details, and mock blockchain hash
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - amount
                - recipient
                - address
              properties:
                amount:
                  type: number
                  format: double
                  description: Amount of MNEE to send
                recipient:
                  type: string
                  description: Name or identifier of the recipient
                address:
                  type: string
                  description: Wallet address of the recipient (Ethereum format)
      responses:
        '201':
          description: Transaction created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  transactionId:
                    type: string
                  transaction:
                    $ref: '#/components/schemas/Transaction'
                  txHash:
                    type: string
                    description: Mock blockchain transaction hash (0x + 64 hex chars)
        '400':
          description: Invalid request data or insufficient balance
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  details:
                    type: object
                    properties:
                      requested:
                        type: number
                      available:
                        type: number
        '401':
          description: Unauthorized

  /wallet/receive:
    post:
      summary: Generate wallet address and QR code for receiving MNEE
      description: |
        Generate a mock wallet address and QR code for receiving MNEE.
        This will:
        - Generate mock Ethereum wallet address (0x + 40 hex characters)
        - Generate QR code as base64 data URL using the address
        - If amount is provided, encode it in the QR code for payment request
        - **Does NOT create a transaction** (transaction created when funds are actually received)
        - Return wallet address and QR code data
      security:
        - bearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                amount:
                  type: number
                  format: double
                  description: Optional amount for payment request QR code
      responses:
        '200':
          description: Wallet address and QR code generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  address:
                    type: string
                    description: Mock Ethereum wallet address (0x + 40 hex chars)
                  qrCode:
                    type: string
                    description: Base64 encoded QR code data URL
                  amount:
                    type: number
                    description: Amount if provided in request
        '400':
          description: Invalid request data
        '401':
          description: Unauthorized

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      required:
        - id
        - email
      properties:
        id:
          type: string
        email:
          type: string
          format: email
        name:
          type: string

    Org:
      type: object
      required:
        - id
        - kybStatus
      properties:
        id:
          type: string
        name:
          type: string
        kybStatus:
          type: string
          enum:
            - approved
            - pending
            - rejected

    MoneyBalance:
      type: object
      required:
        - currency
        - available
        - pending
        - updatedAt
      properties:
        currency:
          type: string
        available:
          type: number
          format: double
        pending:
          type: number
          format: double
        updatedAt:
          type: string
          format: date-time

    TransactionType:
      type: string
      enum:
        - in
        - out

    TransactionStatus:
      type: string
      enum:
        - pending
        - posted
        - failed

    Transaction:
      type: object
      required:
        - id
        - moduleId
        - type
        - method
        - displayType
        - amount
        - currency
        - status
        - createdAt
      properties:
        id:
          type: string
        moduleId:
          type: string
        type:
          $ref: '#/components/schemas/TransactionType'
        method:
          type: string
          enum:
            - stablecoin
            - payout
            - adjustment
            - card
            - bank
            - transfer
        displayType:
          type: string
          enum:
            - send
            - receive
            - buy
            - sell
            - swap
        amount:
          type: number
          format: double
        currency:
          type: string
        status:
          $ref: '#/components/schemas/TransactionStatus'
        createdAt:
          type: string
          format: date-time
        customerEmail:
          type: string
        sendHash:
          type: string
        rockWalletId:
          type: string
        txHashIn:
          type: string
        txHashSwap:
          type: string
        feeUsd:
          type: number
          format: double
        customerAddress:
          type: string

    TransactionsResponse:
      type: object
      required:
        - items
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Transaction'
        nextCursor:
          type: string

    Module:
      type: object
      required:
        - id
        - name
        - kind
        - status
        - configuration
      properties:
        id:
          type: string
        name:
          type: string
        kind:
          type: string
          enum:
            - paywall
            - e-commerce
            - donation
        status:
          type: string
          enum:
            - active
            - inactive
        configuration:
          type: object
          description: Module configuration object containing checkout settings
        codeSnippet:
          type: string
          description: Generated code snippet for embedding
        imageUrl:
          type: string

    CreateModuleRequest:
      type: object
      required:
        - name
        - kind
        - configuration
      properties:
        name:
          type: string
        kind:
          type: string
          enum:
            - paywall
            - e-commerce
            - donation
        configuration:
          type: object
          description: Module configuration object containing checkout settings
        imageUrl:
          type: string

    UpdateModuleRequest:
      type: object
      properties:
        name:
          type: string
        configuration:
          type: object
          description: Module configuration object containing checkout settings
        status:
          type: string
          enum:
            - active
            - inactive
        imageUrl:
          type: string

    ApiKey:
      type: object
      required:
        - id
        - last4
        - createdAt
        - active
      properties:
        id:
          type: string
        last4:
          type: string
        name:
          type: string
          nullable: true
          description: Optional label for the API key (e.g., "Production API")
        createdAt:
          type: string
          format: date-time
        lastUsedAt:
          type: string
          format: date-time
          nullable: true
          description: Timestamp when the API key was last used
        active:
          type: boolean

    ApiKeysResponse:
      type: object
      required:
        - items
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ApiKey'

    ApiKeyResponse:
      type: object
      required:
        - id
        - key
        - last4
        - createdAt
        - active
      properties:
        id:
          type: string
        key:
          type: string
          description: Full API key - only shown once at creation time
        last4:
          type: string
        name:
          type: string
          nullable: true
          description: Optional label for the API key
        createdAt:
          type: string
          format: date-time
        active:
          type: boolean

    AuthResponse:
      type: object
      required:
        - accessToken
        - user
        - org
      properties:
        accessToken:
          type: string
        user:
          $ref: '#/components/schemas/User'
        org:
          $ref: '#/components/schemas/Org'

    MeResponse:
      type: object
      required:
        - user
        - org
      properties:
        user:
          $ref: '#/components/schemas/User'
        org:
          $ref: '#/components/schemas/Org'










